var ReconnectingWebSocket=function(){"use strict";var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function e(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function n(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(o=i.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s}(arguments[t]));return e}function t(e,t){this.target=t,this.type=e}var r,i=(e(s,r=t),s);function s(e,t){t=r.call(this,"error",t)||this;return t.message=e.message,t.error=e,t}var c,u=(e(a,c=t),a);function a(e,t,n){void 0===e&&(e=1e3),void 0===t&&(t="");n=c.call(this,"close",n)||this;return n.wasClean=!0,n.code=e,n.reason=t,n}var l={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};function h(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(t){o._debug("open event");var e=o._options.minUptime,e=void 0===e?l.minUptime:e;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},e),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(e){var t;return null===(t=o._ws)||void 0===t?void 0:t.send(e)}),o._messageQueue=[],o.onopen&&o.onopen(t),o._listeners.open.forEach(function(e){return o._callEventListener(t,e)})},this._handleMessage=function(t){o._debug("message event"),o.onmessage&&o.onmessage(t),o._listeners.message.forEach(function(e){return o._callEventListener(t,e)})},this._handleError=function(t){o._debug("error event",t.message),o._disconnect(void 0,"TIMEOUT"===t.message?"timeout":void 0),o.onerror&&o.onerror(t),o._debug("exec error listeners"),o._listeners.error.forEach(function(e){return o._callEventListener(t,e)}),o._connect()},this._handleClose=function(t){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(t),o._listeners.close.forEach(function(e){return o._callEventListener(t,e)})},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(h,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(h,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(h,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(h,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"CONNECTING",{get:function(){return h.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"OPEN",{get:function(){return h.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"CLOSING",{get:function(){return h.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"CLOSED",{get:function(){return h.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?h.CLOSED:h.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),h.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},h.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED&&this._disconnect(e,t),this._connect()},h.prototype.send=function(e){var t;this._ws&&this._ws.readyState===this.OPEN?(this._debug("send",e),this._ws.send(e)):(t=this._options.maxEnqueuedMessages,this._messageQueue.length<(void 0===t?l.maxEnqueuedMessages:t)&&(this._debug("enqueue",e),this._messageQueue.push(e)))},h.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},h.prototype.dispatchEvent=function(e){var t,n,o,r,i,s=this._listeners[e.type];if(s)try{for(var c=(o=s,r="function"==typeof Symbol&&o[Symbol.iterator],i=0,r?r.call(o):{next:function(){return{value:(o=o&&i>=o.length?void 0:o)&&o[i++],done:!o}}}),u=c.next();!u.done;u=c.next()){var a=u.value;this._callEventListener(e,a)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return!0},h.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},h.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,n(["RWS>"],e))},h.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=e.minReconnectionDelay,o=e.maxReconnectionDelay,e=void 0===o?l.maxReconnectionDelay:o,o=0;return 0<this._retryCount&&e<(o=(void 0===n?l.minReconnectionDelay:n)*Math.pow(void 0===t?l.reconnectionDelayGrowFactor:t,this._retryCount-1))&&(o=e),this._debug("next delay",o),o},h.prototype._wait=function(){var t=this;return new Promise(function(e){setTimeout(e,t._getNextDelay())})},h.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){e=e();if("string"==typeof e)return Promise.resolve(e);if(e.then)return e}throw Error("Invalid URL")},h.prototype._connect=function(){var t=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var e=this._options,n=e.maxRetries,o=void 0===n?l.maxRetries:n,n=e.connectionTimeout,r=void 0===n?l.connectionTimeout:n,e=e.WebSocket,i=void 0===e?function(){if("undefined"!=typeof WebSocket)return WebSocket}():e;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(o=i)||!o||2!==o.CLOSING)throw Error("No valid WebSocket class provided");this._wait().then(function(){return t._getNextUrl(t._url)}).then(function(e){t._closeCalled||(t._debug("connect",{url:e,protocols:t._protocols}),t._ws=t._protocols?new i(e,t._protocols):new i(e),t._ws.binaryType=t._binaryType,t._connectLock=!1,t._addListeners(),t._connectTimeout=setTimeout(function(){return t._handleTimeout()},r))})}}},h.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new i(Error("TIMEOUT"),this))},h.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new u(e,t,this))}catch(e){}}},h.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},h.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},h.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},h.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},h.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},h}();